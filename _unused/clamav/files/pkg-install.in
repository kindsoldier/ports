#!/bin/sh

set -x

CL_PREFIX="%%PREFIX%%"
CL_DB_DIR="%%CL_DB_DIR%%"
CL_RUN_DIR="%%CL_RUN_DIR%%"
CL_LOG_DIR="%%CL_LOG_DIR%%"

OWNER="%%CL_OWNER%%"
GROUP="%%CL_GROUP%%"
OWNER_ID="%%CL_OWNER_ID%%"
GROUP_ID="%%CL_GROUP_ID%%"

case $2 in 
    PRE-INSTALL)
	pw group add ${GROUP} -g ${GROUP_ID}
	pw user add ${OWNER} -u ${OWNER_ID}  -g ${GROUP} \
	    -d /var/tmp -s /usr/sbin/nologin   \
	    -c "clamav"
	pw user mod ${OWNER} -d /var/tmp
	pw group mod ${GROUP} -M ${OWNER}

	for dir in ${CL_DB_DIR} ${CL_LOG_DIR} ${CL_RUN_DIR}; do
	    install -d -m 0700 -o ${OWNER} -g ${GROUP} ${dir}
	done
	chmod 0755 ${CL_RUN_DIR}
	;;
    POST-INSTALL)
	for file in daily.cvd main.cvd; do
		test -r ${CL_DB_DIR}/${file} || \
		    cp -v ${CL_PREFIX}/share/clamav/${file} ${CL_DB_DIR}/${file}
		chown ${OWNER}:${GROUP} ${CL_DB_DIR}/${file}
		chmod 0644 ${CL_DB_DIR}/${file} 
	done
	;;
esac
#EOF
