#
# $Id$
#
PORTNAME=	pear
PORTVERSION=	1.9.4
CATEGORIES=	devel
MASTER_SITES=	http://miwibox.org/distfiles/

MAINTAINER=	miwi@FreeBSD.org
COMMENT=	PEAR framework for PHP

USES=		tar:bzip2
NO_BUILD=	yes

#WANT_PHP_CLI=	yes
#USE_PHP=	pcre xml
#USE_PHP_BUILD=	yes

PEARDIR=	${PREFIX}/share/pear

post-patch:
	${REINPLACE_CMD} -e "s|%%PREFIX%%|${PREFIX}|"   ${WRKSRC}/go-pear
	${REINPLACE_CMD} -e "s|%%BUNDLEDIR%%|${WRKSRC}/go-pear-bundle|" ${WRKSRC}/go-pear
	${REINPLACE_CMD} -e "s|%%TMPDIR%%|/tmp/pear|"  ${WRKSRC}/go-pear

	cd ${WRKSRC}/go-pear-bundle && ${MKDIR} tmp
	cd ${WRKSRC}/go-pear-bundle && ${TAR} -C tmp -xf PEAR-${PORTVERSION}.tar
	cd ${WRKSRC}/go-pear-bundle/tmp/PEAR-${PORTVERSION} && \
               ${PATCH} -s -p0 < ${FILESDIR}/extra-patch-PEAR-Config.php
	${RM} ${WRKSRC}/go-pear-bundle/tmp/PEAR-${PORTVERSION}/PEAR/Config.php.orig
	${MD5} -q ${WRKSRC}/go-pear-bundle/tmp/PEAR-${PORTVERSION}/PEAR/Config.php > ${WRKSRC}/Config.php.md5
	${REINPLACE_CMD} -E -e \
	   "s|(file md5sum=\").*(\" name=\"PEAR/Config.php\" role=\"php\")|\1`${CAT} ${WRKSRC}/Config.php.md5`\2|g" \
		${WRKSRC}/go-pear-bundle/tmp/package2.xml ${WRKSRC}/go-pear-bundle/package2.xml
	cd ${WRKSRC}/go-pear-bundle/tmp && ${TAR} -cf ../PEAR-${PORTVERSION}.tar package2.xml PEAR-${PORTVERSION} package.xml

do-install:
	cd ${WRKSRC} && ${SETENV} DESTDIR=${STAGEDIR} ${LOCALBASE}/bin/php -q ./go-pear
	${REINPLACE_CMD} -e "s|<?php|<?php dl('pcre.so'); dl('xml.so');|" \
		${STAGEDIR}${PEARDIR}/peclcmd.php
# pear violates stage when staging as root, hide this
#.if defined(PACKAGE_BUILDING)
#	echo ${RM} -rf ${PEARDIR}
#.endif
# Clean up orphans re-generated by pkg-install
	${RM} -rf ${STAGEDIR}${PEARDIR}/.depdb
	${RM} -rf ${STAGEDIR}${PEARDIR}/.depdblock 
	${RM} -rf ${STAGEDIR}${PEARDIR}/.filemap
	${RM} -rf ${STAGEDIR}${PEARDIR}/.lock


.include <bsd.port.mk>
#EOF
